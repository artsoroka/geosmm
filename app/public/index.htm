<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<script src="http://api-maps.yandex.ru/2.1/?load=package.full&amp;lang=ru-RU" type="text/javascript"></script>
	<style type="text/css">
		.map {
			background: #A0BAF7;
			display: block;
			position: fixed;
			width: 100%;
			height: 100%; 
			top: 0;
			left: 0;
		}

		.nav  {
			display: block;  
			position:fixed;
			background: rgba(255, 255, 255, 0.7); 
			z-index: 10;
			width: 100%;
			height: 33px; 
			top: 0;
			left: 0;		
		}
	</style>
</head>
<body>
	<div class="nav">navbar</div>	
    <div id="map" class="map"></div>
<script type="text/javascript">
var myMap;

var calcDistance = function(coordinates){
	  var p1 = coordinates[0];
	  var p2 = coordinates[1]; 
      var R = 6371; // km
      var dLat = toRad(p2[0] - p1[0]);
      var dLon = toRad(p2[1] - p1[1]);
      var lat1 = toRad(p1[0]);
      var lat2 = toRad(p2[0]);

      var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
      var d = R * c;
      return d;
    }

    // Converts numeric degrees to radians
var toRad = function(Value) {
        return Value * Math.PI / 180;
}

var getMedia = function(query, cb){
	var endpoint = '/api/photos'; 
	var queryString = []; 
	for(i in query){
		queryString.push([i, query[i]].join('=')); 
	}

	var xhr = new XMLHttpRequest()
	var url = [endpoint, queryString.join('&')].join('?'); 
	xhr.open('GET', url);
	xhr.onload = function(e){
		if(xhr.status != 200){
			return cb(JSON.parse(xhr.response).error, null); 		
		} 
		cb(false, JSON.parse(xhr.response)); 
	} 
	xhr.send(); 
}; 

ymaps.ready(function(){
	var config = {
		center: [59.93, 30.32],
		controls: ['zoomControl'], 
		zoom: 11
    }, 
	myMap = new ymaps.Map("map", config);
	MAP = myMap; 
	myMap.container.fitToViewport();

	myMap.events.add('actionend', function(e){
		var coords = myMap.getCenter(); 
		console.log('action end', coords);
		var _myMap = myMap;  
		getMedia({
			lat: coords[0], 
			long: coords[1]
		}, function(err, data){
			if( err ) return console.log(err); 
			
			if( ! data.response.items.length){
				return console.log('no data found on the map'); 
			} 
			//myMap.geoObjects.removeAll(); 
		
			data.response.items.forEach(function(item){
				
				myMap.geoObjects.add(new ymaps.Placemark([item.lat, item.long], {
				            balloonContent: '<img src="' + item.photo_604 +'">' 
				        }, {
				            preset: 'islands#circleDotIcon',
				            iconColor: 'yellow'
				        }))

			})
	 	
		}); 
	});
	
});
    
</script>
</body>
</html>
